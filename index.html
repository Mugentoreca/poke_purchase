<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>カード一覧</title>
<style>
/* ====================
   ルート変数
   ==================== */
:root {
  --color-primary: #f88379; /* メインカラー */
  --color-gray-light: #f9f9f9; /* 背景用薄グレー */
  --color-gray-border: #ccc; /* 境界線色 */
  --font-size-base: 14px; /* 基本フォントサイズ */
  --font-size-small: 12px; 
  --font-size-xsmall: 10px;
  --card-border-radius: 6px; /* カード角丸 */
  --spacing-xs: 4px; 
  --spacing-sm: 8px;
  --spacing-md: 16px;
}

/* ====================
   全体設定
   ==================== */
body { font-family: sans-serif; padding: 10px; background: #fff; }
h1 { font-size: 18px; font-weight: bold; margin-bottom: 8px; }

/* ====================
   注意書き
   ==================== */
.notice {
  font-size: 12px;
  color: #d00;
  margin-bottom: 10px;
}

/* ====================
   コントロール全体
   ==================== */
.controls { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }

/* ====================
   検索ボックス
   ==================== */
.search-wrapper { display: flex; width: 100%; }
#searchInput { flex: 1; padding: 12px; font-size: 16px; border: 1px solid var(--color-gray-border); border-radius: 4px; }

/* ====================
   キーワードボタン
   ==================== */
.keyword-buttons { display: flex; flex-wrap: wrap; gap: var(--spacing-sm); overflow-x: auto; }
.keyword-group { margin-bottom: 8px; }
.keyword-group strong { display: block; margin-bottom: 4px; }
.keyword-buttons button { font-size: 14px; padding: 8px 12px; background-color: #eee; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }

/* ====================
   リセット・ソート
   ==================== */
.buttons-wrapper { display: flex; gap: 8px; width: 100%; }
#resetButton { background-color: #666; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
.buttons-wrapper button, .buttons-wrapper select { flex: 1; padding: 8px; font-size: var(--font-size-base); box-sizing: border-box; }

/* ====================
   カードグリッド
   ==================== */
.card-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
@media (max-width: 480px) { .card-grid { grid-template-columns: repeat(6, 1fr); } }
@media (min-width: 768px) { .card-grid { grid-template-columns: repeat(8, 1fr); } }

/* ====================
   カード
   ==================== */
.card { border: 1px solid var(--color-gray-border); border-radius: var(--card-border-radius); padding: 4px; text-align: center; background-color: var(--color-gray-light); font-size: var(--font-size-xsmall); display: flex; flex-direction: column; justify-content: space-between; min-height: 210px; }
.card img { width: 100%; height: auto; max-height: 120px; object-fit: contain; margin-bottom: 6px; }
.card-name { font-weight: bold; margin: 2px 0; font-size: 7px; white-space: normal; cursor: pointer; }
.card-texts { display: flex; flex-direction: column; justify-content: flex-start; flex-grow: 1; }
.card-quantity { font-weight: bold; color: #a66b6f; }
@media (max-width: 480px) { .card-quantity { font-size: 10px; } }
@media (min-width: 481px) { .card-quantity { font-size: 13px; } }
.card-note { font-size: 10px; color: #555; margin-top: 2px; }
.card-price { font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: auto; }
@media (max-width: 480px) { .card-price { font-size: 10px; } }
.price-store { color: #e53935 !important; font-weight: bold; }
.price-mail { color: #43a047 !important; font-weight: bold; }
.gray-out { opacity: 0.9; filter: grayscale(100%); pointer-events: none; }

/* ====================
   もっと見るボタン
   ==================== */
#loadMoreButton { margin-top: 30px; width: 100%; padding: 36px 12px; font-size: 15px; border: none; background-color: var(--color-primary); color: white; border-radius: var(--card-border-radius); cursor: pointer; }
</style>
</head>
<body>

<h1>【ポケモンカード買取表】</h1>

<!-- ====================
     注意書き（HTML2ベース）
     ==================== -->
<div class="notice">
※データ容量の都合上、読み込みに時間がかかる場合があります。<br>
※価格や募集枚数の更新にラグがある場合があります。<br>
※相場の変動や在庫状況によって、予告なく募集枚数や価格が変動する場合があります。<br>
※募集枚数が0枚の場合でも購入できる場合があります。<br>
※基本的に画像のカードは【PSA10】の価格でございます。未開封商品は【未開封】と記載のある商品の価格です。
</div>

<div class="controls">
  <div class="search-wrapper">
    <input type="text" id="searchInput" placeholder="カード名や型番、収録パックで検索" />
  </div>

  <!-- ====================
       キーワードボタン（カテゴリ分け）
       ==================== -->
  <div class="keyword-buttons">
    <div class="keyword-group">
      <strong>ポケモン種族</strong>
      <button onclick="searchKeyword('リザードン')">リザードン系統</button>
      <button onclick="searchKeyword('ピカチュウ')">ピカチュウ系統</button>
      <button onclick="searchKeyword('ミュウ')">ミュウ系統</button>
      <button onclick="searchKeyword('ナンジャモ')">ナンジャモ系統</button>
    </div>
    <div class="keyword-group">
      <strong>キャラクター</strong>
      <button onclick="searchKeyword('リーリエ')">リーリエ系統</button>
      <button onclick="searchKeyword('マリィ')">マリィ系統</button>
    </div>
    <div class="keyword-group">
      <strong>レア・特殊</strong>
      <button onclick="searchKeyword('SAR')">SAR系統</button>
      <button onclick="searchKeyword('V')">VMAX・V系統</button>
      <button onclick="searchKeyword('GX')">GX系統</button>
      <button onclick="searchKeyword('ex')">ex・EX系統</button>
      <button onclick="searchKeyword('nagaba')">nagaba系統</button>
      <button onclick="searchKeyword('メガ')">メガシンカ系統</button>
      <button onclick="searchKeyword('マス')">マスターボール系統</button>
      <button onclick="searchKeyword('テラスタル')">テラスタル系統</button> 
      <button onclick="searchKeyword('th')">周年系統</button>
    </div>
  </div>

  <div class="buttons-wrapper">
    <button id="resetButton" aria-label="検索条件をリセット">検索条件をリセット</button>
    <select id="sortSelect">
      <option value="price">価格（高い順）</option>
      <option value="priceLow">価格（安い順）</option>
    </select>
  </div>
</div>

<div class="card-grid" id="cardList"></div>
<button id="loadMoreButton" aria-label="さらにカードを読み込む">こちらをタップして、さらにカードを読み込む</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script>
const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTgSjXDetFkCm904ILmhH9UB24MbFrPV0TNdOKFJI_jxr7hvDy8hymSpj4ZX34_4ICBmqHa-QAT8qSo/pub?gid=1393270336&single=true&output=csv';

let cards = [];
let filteredCards = [];
let currentPage = 0;
const cardsPerPage = 96;

// カタカナ→ひらがな
function kataToHira(str){
  return str.replace(/[\u30a1-\u30f6]/g, function(match){
    return String.fromCharCode(match.charCodeAt(0)-0x60);
  });
}

// ローマ字大文字→小文字、全角数字→半角、記号削除
function normalizeLatin(str){
  return str
    .toLowerCase()
    .replace(/[Ａ-Ｚａ-ｚ０-９]/g, s => String.fromCharCode(s.charCodeAt(0)-0xFEE0))
    .replace(/[^a-z0-9ぁ-ん]/g, '');
}

// 入力を分割して配列化
function splitKeywords(str){
  return str.split(/[\s,・／]+/).map(s => normalizeLatin(kataToHira(s))).filter(Boolean);
}

function searchKeyword(keyword){
  document.getElementById('searchInput').value = keyword;
  applyFilterSort();
}

function applyFilterSort(){
  const keyword = document.getElementById('searchInput').value.trim();
  const keywords = splitKeywords(keyword);
  const sortValue = document.getElementById('sortSelect').value;

  filteredCards = cards.filter(card => {
    const target = normalizeLatin(kataToHira(card["カード名 型番 レアリティ"] || ""));
    return keywords.every(k => target.includes(k));
  });

  if(sortValue==='price'){
    filteredCards.sort((a,b)=>{
      return (Number((b["店頭価格"]||'0').replace(/[¥,\s]/g,''))||0)
           - (Number((a["店頭価格"]||'0').replace(/[¥,\s]/g,''))||0);
    });
  } else if(sortValue==='priceLow'){
    filteredCards.sort((a,b)=>{
      return (Number((a["店頭価格"]||'0').replace(/[¥,\s]/g,''))||0)
           - (Number((b["店頭価格"]||'0').replace(/[¥,\s]/g,''))||0);
    });
  }

  currentPage=0;
  displayNextPage();
}

async function fetchCsvData(){
  document.getElementById('cardList').textContent='読み込み中.....';
  try{
    const res = await fetch(csvUrl);
    const text = await res.text();
    const parsed = Papa.parse(text,{header:true, skipEmptyLines:true});
    cards = parsed.data.map(card=>({
      "カード名 型番 レアリティ": card["カード名 型番 レアリティ"],
      "募集枚数": card["募集枚数"],
      "店頭価格": card["店頭価格"],
      "最低価格": card["最低価格"],
      "画像URL": card["画像URL"],
      "グレイアウト発動時専用": card["グレイアウト発動時専用"]
    }));
    applyFilterSort();
  } catch(e){
    console.error(e);
    document.getElementById('cardList').textContent='データの読み込みに失敗しました。';
  }
}

function displayNextPage(){
  const start = currentPage*cardsPerPage;
  const end = start+cardsPerPage;
  const cardsToShow = filteredCards.slice(start,end);
  if(currentPage===0) document.getElementById('cardList').innerHTML='';

  let html='';
  cardsToShow.forEach(card=>{
    const isZero = (card["募集枚数"]||"").trim()==="0枚募集中";
    const grayClass = isZero?'gray-out':'';
    const normalPrice = Number((card["店頭価格"]||'0').replace(/[¥,\s]/g,''))||0;
    const foilPrice = Number((card["最低価格"]||'0').replace(/[¥,\s]/g,''))||0;
    const normalText = `<span class="price-store">店頭買取価格</span><br><span class="price-store">¥${normalPrice.toLocaleString()}</span>`;
    const foilText = `<span class="price-mail">最低買取価格</span><br><span class="price-mail">¥${foilPrice.toLocaleString()}</span>`;
    const altText = card["グレイアウト発動時専用"]||'';
    const priceDisplay = isZero ? (altText?altText:'店頭で確認') : `${normalText}<br>${foilText}`;
    html += `<div class="card ${grayClass}">
      <img data-src="${card.画像URL}" alt="${card["カード名 型番 レアリティ"]}" class="lazy"/>
      <div class="card-name">${card["カード名 型番 レアリティ"]}</div>
      <div class="card-texts">
        <div class="card-quantity">本日${isZero?'<br>満額は終了':(card["募集枚数"]||'-')}</div>
        <div class="card-note">${isZero?'ただいまの価格':''}</div>
      </div>
      <div class="card-price">${priceDisplay}</div>
    </div>`;
  });

  document.getElementById('cardList').insertAdjacentHTML('beforeend',html);
  currentPage++;
  document.getElementById('loadMoreButton').style.display=(end>=filteredCards.length)?'none':'block';

  // Lazy Load
  const lazyImages = document.querySelectorAll('img.lazy');
  const observer = new IntersectionObserver(entries=>{
    entries.forEach(entry=>{
      if(entry.isIntersecting){
        const img=entry.target;
        img.src=img.dataset.src;
        img.classList.remove('lazy');
        observer.unobserve(img);
      }
    });
  });
  lazyImages.forEach(img=>observer.observe(img));
}

document.getElementById('loadMoreButton').addEventListener('click', displayNextPage);
document.getElementById('resetButton').addEventListener('click',()=>{
  document.getElementById('searchInput').value='';
  document.getElementById('sortSelect').value='price';
  applyFilterSort();
});
document.getElementById('searchInput').addEventListener('input', applyFilterSort);
document.getElementById('sortSelect').addEventListener('change', applyFilterSort);

fetchCsvData();
</script>

</body>
</html>
